# To use another compiler, such clang++, set the CXX variable
CXX=em++
# variables used to generate a source snapshot of the GIT repo
CXXFLAGS=-std=c++11 -Oz -Iapi -flto -fwasm-exceptions -sSTRICT=1
TARGET=pict.mjs
TARGET_WASM=pict.wasm
TARGET_TSD=pict.d.ts
OBJS = $(OBJS_API) $(OBJS_CLI)
OBJS_API = api/combination.o api/deriver.o api/exclusion.o
OBJS_API += api/model.o api/parameter.o api/pictapi.o
OBJS_API += api/task.o api/worklist.o
OBJS_CLI = cli/ccommon.o cli/cmdline.o
OBJS_CLI += cli/common.o cli/cparser.o cli/ctokenizer.o cli/gcd.o
OBJS_CLI += cli/gcdexcl.o cli/gcdmodel.o cli/model.o cli/mparser.o
OBJS_CLI += cli/pict.o cli/strings.o

wasm: $(OBJS)
	$(CXX) $(OBJS) -Oz -flto -fwasm-exceptions --emit-tsd=$(TARGET_TSD) -sALLOW_MEMORY_GROWTH=1 -sMALLOC=emmalloc -sWASMFS=1 -sFORCE_FILESYSTEM=1 -sSTRICT=1 -sMODULARIZE=1 -sEXPORT_ES6=1 -sINVOKE_RUN=0 -sEXPORTED_RUNTIME_METHODS=callMain,FS -sINCOMING_MODULE_JS_API=print,printErr -o $(TARGET)

clean:
	rm -f $(TARGET) $(TARGET_WASM) $(TARGET_TSD) $(OBJS)

all: wasm

.PHONY: all clean
